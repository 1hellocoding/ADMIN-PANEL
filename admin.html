<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel | MyBandsTonight</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<style>
    body { font-family: 'Inter', sans-serif; }
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #f1f5f9; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    .sidebar-link { transition: all 0.2s ease-in-out; cursor: pointer; }
    .sidebar-link:hover, .sidebar-link.active { background-color: #eef2ff; color: #4f46e5; }
    .sidebar-link.active { font-weight: 600; border-right: 3px solid #4f46e5; }
    .admin-table th { background-color: #f8fafc; font-weight: 600; color: #475569; }
    .admin-table tr:hover { background-color: #f1f5f9; }
    #loadingOverlay { position: fixed; inset: 0; background: rgba(249,249,249,0.85); backdrop-filter: blur(5px); z-index: 30000; display: flex; justify-content: center; align-items: center; transition: opacity 0.5s ease; }
    .btn-spinner { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    
    #customAlert-container {
        position: fixed; top: 0; left: 0; right: 0;
        display: flex; align-items: flex-start; justify-content: center;
        padding-top: 20px; z-index: 9999; pointer-events: none;
    }
    .custom-alert-box {
        color: white; padding: 1rem 1.5rem; border-radius: 0.75rem;
        box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); font-weight: 500;
        opacity: 0; animation: slideDownFadeIn 0.4s ease-out forwards;
    }
    .custom-alert-box.fade-out { animation: slideUpFadeOut 0.4s ease-in forwards; }
    .alert-info { background: linear-gradient(135deg, #3b82f6, #6366f1); }
    .alert-success { background: linear-gradient(135deg, #22c55e, #16a34a); }
    .alert-error { background: linear-gradient(135deg, #ef4444, #dc2626); }

    .confirm-modal {
        max-width: 400px; width: 100%;
        background: white; border-radius: 0.75rem; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
        text-align: center; padding: 2rem;
        opacity: 0; animation: popIn 0.3s ease-out forwards;
    }
    @keyframes popIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; }}
    @keyframes slideDownFadeIn { from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    @keyframes slideUpFadeOut { from { transform: translateY(0); opacity: 1; } to { transform: translateY(-30px); opacity: 0; } }
</style>
</head>
<body class="bg-slate-50 text-slate-800">

<div id="password-overlay" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-center justify-center p-4"><div class="w-full max-w-md bg-white rounded-xl shadow-2xl p-8"><form id="password-form"><h2 class="text-2xl font-bold text-slate-800 text-center mb-2">Admin Access</h2><p class="text-slate-500 text-center mb-6">Please enter the password to continue.</p><div class="space-y-4"><input type="password" id="password-input" placeholder="Password" class="w-full px-4 py-3 bg-slate-100 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"><button type="submit" id="login-button" class="w-full py-3 px-5 bg-gradient-to-br from-blue-500 to-indigo-600 text-white font-semibold rounded-lg shadow-md hover:from-blue-600 hover:to-indigo-700">Login</button></div><p id="password-error" class="text-red-500 text-sm text-center mt-4 h-4"></p></form></div></div>

<div class="relative min-h-screen md:flex">
    <div id="sidebar-overlay" class="fixed inset-0 bg-black/60 z-30 md:hidden hidden"></div>
    <aside id="sidebar" class="w-64 bg-white border-r border-slate-200 flex-shrink-0 fixed inset-y-0 left-0 z-40 -translate-x-full transition-transform duration-300 ease-in-out md:relative md:translate-x-0">
        <div class="p-6 text-center border-b"><h1 class="text-2xl font-extrabold text-indigo-600 tracking-wider">ADMIN</h1></div>
        <nav class="mt-6">
            <a id="nav-dashboard" class="sidebar-link flex items-center px-6 py-3 text-slate-700"><i class="fas fa-tachometer-alt w-6 mr-4"></i> Dashboard</a>
            <a id="nav-reviews" class="sidebar-link flex items-center px-6 py-3 text-slate-700"><i class="fas fa-star w-6 mr-4"></i> Reviews</a>
            <a id="nav-gigs" class="sidebar-link flex items-center px-6 py-3 text-slate-700"><i class="fas fa-guitar w-6 mr-4"></i> Gigs</a>
            <a id="nav-venues" class="sidebar-link flex items-center px-6 py-3 text-slate-700"><i class="fas fa-map-marker-alt w-6 mr-4"></i> Venues</a>
            <a id="nav-gallery" class="sidebar-link flex items-center px-6 py-3 text-slate-700"><i class="fas fa-images w-6 mr-4"></i> Gallery</a>
        </nav>
    </aside>

    <main class="flex-1 p-4 md:p-8 overflow-y-auto w-full">
        <button id="burger-btn" class="text-slate-600 hover:text-indigo-600 md:hidden mb-4 flex items-center gap-2 px-3 py-2 rounded-md bg-white border">
            <i class="fas fa-bars fa-lg"></i>
            <span class="font-semibold">Menu</span>
        </button>

        <div id="dashboard-content">
            <h1 class="text-2xl sm:text-3xl font-bold text-slate-900 mb-2">Welcome Back!</h1>
            <p class="text-slate-600 mb-8">Here's a snapshot of your site's activity.</p>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white p-6 rounded-xl shadow-md border flex items-center"><div class="p-4 bg-cyan-100 text-cyan-600 rounded-full mr-4"><i class="fas fa-calendar-alt fa-2x"></i></div><div><p class="text-sm text-slate-500 font-medium">Upcoming Gigs</p><p id="dashboard-stat-upcoming" class="text-3xl font-bold">0</p></div></div>
                <div class="bg-white p-6 rounded-xl shadow-md border flex items-center"><div class="p-4 bg-yellow-100 text-yellow-600 rounded-full mr-4"><i class="fas fa-hourglass-half fa-2x"></i></div><div><p class="text-sm text-slate-500 font-medium">Pending Reviews</p><p id="dashboard-stat-pending" class="text-3xl font-bold">0</p></div></div>
                <div class="bg-white p-6 rounded-xl shadow-md border flex items-center"><div class="p-4 bg-purple-100 text-purple-600 rounded-full mr-4"><i class="fas fa-guitar fa-2x"></i></div><div><p class="text-sm text-slate-500 font-medium">Total Gigs</p><p id="dashboard-stat-total-gigs" class="text-3xl font-bold">0</p></div></div>
                <div class="bg-white p-6 rounded-xl shadow-md border flex items-center"><div class="p-4 bg-green-100 text-green-600 rounded-full mr-4"><i class="fas fa-users fa-2x"></i></div><div><p class="text-sm text-slate-500 font-medium">Total Reviews</p><p id="dashboard-stat-total-reviews" class="text-3xl font-bold">0</p></div></div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 bg-white rounded-xl shadow-md border">
                    <div class="p-6 border-b flex justify-between items-center"><h2 class="text-xl font-semibold">Upcoming Gigs</h2><button id="dashboard-view-gigs-btn" class="text-sm font-semibold text-indigo-600 hover:text-indigo-800">View All &rarr;</button></div>
                    <div id="dashboard-upcoming-gigs" class="p-6 space-y-4"><p class="text-slate-500 text-center py-8">Loading upcoming gigs...</p></div>
                </div>
                <div class="bg-white rounded-xl shadow-md border">
                    <div class="p-6 border-b flex justify-between items-center"><h2 class="text-xl font-semibold">Pending Reviews</h2><button id="dashboard-view-reviews-btn" class="text-sm font-semibold text-indigo-600 hover:text-indigo-800">View All &rarr;</button></div>
                    <div id="dashboard-pending-reviews" class="p-6 space-y-4"><p class="text-slate-500 text-center py-8">Loading pending reviews...</p></div>
                </div>
            </div>
        </div>

        <div id="reviews-content" class="hidden"><h1 class="text-2xl sm:text-3xl font-bold text-slate-900 mb-8">Reviews Management</h1><div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8"><div class="bg-white p-6 rounded-xl shadow-md border flex items-center"><div class="p-4 bg-blue-100 text-blue-600 rounded-full mr-4"><i class="fas fa-star fa-2x"></i></div><div><p class="text-sm text-slate-500 font-medium">Total Reviews</p><p id="stat-total-reviews" class="text-3xl font-bold">0</p></div></div><div class="bg-white p-6 rounded-xl shadow-md border flex items-center"><div class="p-4 bg-green-100 text-green-600 rounded-full mr-4"><i class="fas fa-check-circle fa-2x"></i></div><div><p class="text-sm text-slate-500 font-medium">Approved Reviews</p><p id="stat-approved-reviews" class="text-3xl font-bold">0</p></div></div><div class="bg-white p-6 rounded-xl shadow-md border flex items-center"><div class="p-4 bg-yellow-100 text-yellow-600 rounded-full mr-4"><i class="fas fa-hourglass-half fa-2x"></i></div><div><p class="text-sm text-slate-500 font-medium">Pending Approval</p><p id="stat-pending-reviews" class="text-3xl font-bold">0</p></div></div></div><div class="bg-white rounded-xl shadow-md border overflow-hidden"><h2 class="text-xl font-semibold p-6 border-b">Manage Reviews</h2><div class="overflow-x-auto"><table class="admin-table w-full text-sm text-left"><thead class="text-xs uppercase"><tr><th class="px-2 md:px-6 py-3">#</th><th class="px-2 md:px-6 py-3">Reviewer</th><th class="px-2 md:px-6 py-3">Band / Venue</th><th class="px-2 md:px-6 py-3">Rating</th><th class="px-2 md:px-6 py-3">Review</th><th class="px-2 md:px-6 py-3 text-center">Status</th><th class="px-2 md:px-6 py-3 text-center">Actions</th></tr></thead><tbody id="reviews-table-body"></tbody></table><div id="no-reviews-message" class="text-center py-12 px-6"><p class="text-slate-500">Loading Reviews...</p></div></div></div></div>

        <div id="gigs-content" class="hidden"><div class="flex flex-col sm:flex-row justify-between sm:items-center mb-8 gap-4"><h1 class="text-2xl sm:text-3xl font-bold text-slate-900">Gigs Management</h1><button id="add-gig-btn" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 flex items-center justify-center gap-2"><i class="fas fa-plus"></i> Add Gig</button></div><div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8"><div class="bg-white p-6 rounded-xl shadow-md border flex items-center"><div class="p-4 bg-purple-100 text-purple-600 rounded-full mr-4"><i class="fas fa-guitar fa-2x"></i></div><div><p class="text-sm text-slate-500 font-medium">Total Gigs</p><p id="stat-total-gigs" class="text-3xl font-bold">0</p></div></div><div class="bg-white p-6 rounded-xl shadow-md border flex items-center"><div class="p-4 bg-cyan-100 text-cyan-600 rounded-full mr-4"><i class="fas fa-calendar-alt fa-2x"></i></div><div><p class="text-sm text-slate-500 font-medium">Upcoming Gigs</p><p id="stat-upcoming-gigs" class="text-3xl font-bold">0</p></div></div><div class="bg-white p-6 rounded-xl shadow-md border flex items-center"><div class="p-4 bg-orange-100 text-orange-600 rounded-full mr-4"><i class="fas fa-history fa-2x"></i></div><div><p class="text-sm text-slate-500 font-medium">Past Gigs</p><p id="stat-past-gigs" class="text-3xl font-bold">0</p></div></div></div><div class="bg-white rounded-xl shadow-md border overflow-hidden"><h2 class="text-xl font-semibold p-6 border-b">Manage Gigs</h2><div class="overflow-x-auto"><table class="admin-table w-full text-sm text-left"><thead class="text-xs uppercase"><tr><th class="px-2 md:px-6 py-3">#</th><th class="px-2 md:px-6 py-3">Date & Time</th><th class="px-2 md:px-6 py-3">Band Name</th><th class="px-2 md:px-6 py-3">Venue Name</th><th class="px-2 md:px-6 py-3">Address</th><th class="px-2 md:px-6 py-3 text-center">Actions</th></tr></thead><tbody id="gigs-table-body"></tbody></table><div id="no-gigs-message" class="text-center py-12 px-6"><p class="text-slate-500">Loading Gigs...</p></div></div></div></div>

        <div id="venues-content" class="hidden">
            <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-8 gap-4"><h1 class="text-2xl sm:text-3xl font-bold text-slate-900">Venues Management</h1><button id="add-venue-btn" class="px-4 py-2 bg-teal-600 text-white font-semibold rounded-lg shadow-md hover:bg-teal-700 flex items-center justify-center gap-2"><i class="fas fa-plus"></i> Add Venue</button></div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-6 rounded-xl shadow-md border flex items-center">
                    <div class="p-4 bg-teal-100 text-teal-600 rounded-full mr-4"><i class="fas fa-map-marker-alt fa-2x"></i></div>
                    <div><p class="text-sm text-slate-500 font-medium">Total Venues</p><p id="stat-total-venues" class="text-3xl font-bold">0</p></div>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-md border overflow-hidden">
                <h2 class="text-xl font-semibold p-6 border-b">Manage Venues</h2>
                <div class="overflow-x-auto">
                    <table class="admin-table w-full text-sm text-left">
                        <thead class="text-xs uppercase">
                            <tr><th class="px-2 md:px-6 py-3">#</th><th class="px-2 md:px-6 py-3">Venue Name</th><th class="px-2 md:px-6 py-3">Address</th><th class="px-2 md:px-6 py-3">Website</th><th class="px-2 md:px-6 py-3">Phone</th><th class="px-2 md:px-6 py-3 text-center">Actions</th></tr>
                        </thead>
                        <tbody id="venues-table-body"></tbody>
                    </table>
                    <div id="no-venues-message" class="text-center py-12 px-6"><p class="text-slate-500">Loading Venues...</p></div>
                </div>
            </div>
        </div>
        
        <div id="gallery-content" class="hidden">
            <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-8 gap-4">
                <h1 class="text-2xl sm:text-3xl font-bold text-slate-900">Gallery Management</h1>
                <button id="add-gallery-btn" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 flex items-center justify-center gap-2"><i class="fas fa-plus"></i> Add Artist</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-6 rounded-xl shadow-md border flex items-center">
                    <div class="p-4 bg-indigo-100 text-indigo-600 rounded-full mr-4"><i class="fas fa-images fa-2x"></i></div>
                    <div><p class="text-sm text-slate-500 font-medium">Total Artists</p><p id="stat-total-gallery-items" class="text-3xl font-bold">0</p></div>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-md border overflow-hidden">
                <h2 class="text-xl font-semibold p-6 border-b">Manage Gallery</h2>
                <div class="overflow-x-auto">
                    <table class="admin-table w-full text-sm text-left">
                        <thead class="text-xs uppercase">
                            <tr><th class="px-2 md:px-6 py-3">#</th><th class="px-2 md:px-6 py-3">Image Preview</th><th class="px-2 md:px-6 py-3">Artist Name</th><th class="px-2 md:px-6 py-3">Website</th><th class="px-2 md:px-6 py-3 text-center">Actions</th></tr>
                        </thead>
                        <tbody id="gallery-table-body"></tbody>
                    </table>
                    <div id="no-gallery-message" class="text-center py-12 px-6"><p class="text-slate-500">Loading Gallery Items...</p></div>
                </div>
            </div>
        </div>
    </main>
</div>

<div id="edit-gig-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-start justify-center p-4 hidden overflow-y-auto"><div class="w-full max-w-3xl bg-white rounded-xl shadow-2xl m-4"><div class="p-6 border-b flex justify-between items-center"><h2 class="text-2xl font-bold text-slate-800">Edit Gig</h2><button class="modal-close-btn text-slate-400 hover:text-slate-600 text-2xl">&times;</button></div><form id="edit-gig-form" class="p-6"><input type="hidden" name="rowId"><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"><div><label class="text-sm font-medium">Date</label><input type="date" name="date" class="w-full mt-1 p-2 border rounded-md"></div><div><label class="text-sm font-medium">Time</label><div class="flex items-center mt-1"><input type="text" name="hour" placeholder="H" maxlength="2" class="w-12 p-2 border rounded-md text-center"><span class="font-bold mx-1">:</span><input type="text" name="minutes" placeholder="MM" maxlength="2" class="w-16 p-2 border rounded-md text-center"><select name="ampm" class="ml-2 p-2 border rounded-md bg-white"><option>AM</option><option>PM</option></select></div></div><div><label class="text-sm font-medium">Band Name</label><input type="text" name="name" class="w-full mt-1 p-2 border rounded-md"></div><div class="lg:col-span-3"><label class="text-sm font-medium">Address</label><input type="text" name="address" class="w-full mt-1 p-2 border rounded-md"></div><div class="lg:col-span-3"><label class="text-sm font-medium">Google Maps Link</label><input type="url" name="googleMapsLink" class="w-full mt-1 p-2 border rounded-md"></div><div><label class="text-sm font-medium">Latitude</label><input type="text" name="latitude" placeholder="e.g., 40.7128" class="w-full mt-1 p-2 border rounded-md"></div><div><label class="text-sm font-medium">Longitude</label><input type="text" name="longitude" placeholder="e.g., -74.0060" class="w-full mt-1 p-2 border rounded-md"></div><div><label class="text-sm font-medium">Band Website</label><input type="url" name="band_website" class="w-full mt-1 p-2 border rounded-md"></div><div><label class="text-sm font-medium">Band Email</label><input type="email" name="band_email" class="w-full mt-1 p-2 border rounded-md"></div><div><label class="text-sm font-medium">Venue Name</label><input type="text" name="venue_name" class="w-full mt-1 p-2 border rounded-md"></div><div><label class="text-sm font-medium">Venue Website</label><input type="url" name="venue_website" class="w-full mt-1 p-2 border rounded-md"></div><div><label class="text-sm font-medium">Venue Phone</label><input type="tel" name="venue_phone_number" class="w-full mt-1 p-2 border rounded-md"></div><div><label class="text-sm font-medium">Venue Email</label><input type="email" name="venue_email" class="w-full mt-1 p-2 border rounded-md"></div></div><div class="mt-6 flex justify-end gap-4"><button type="button" class="modal-cancel-btn px-4 py-2 bg-slate-200 rounded-md">Cancel</button><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md">Save Changes</button></div></form></div></div>
<div id="add-gig-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-start justify-center p-4 hidden overflow-y-auto"><div class="w-full max-w-3xl bg-white rounded-xl shadow-2xl m-4"><div class="p-6 border-b flex justify-between items-center"><h2 class="text-2xl font-bold text-slate-800">Add New Gig</h2><button class="modal-close-btn text-slate-400 hover:text-slate-600 text-2xl">&times;</button></div><form id="add-gig-form" class="p-6"><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"><div><label class="text-sm font-medium">Date</label><input type="date" name="date" class="w-full mt-1 p-2 border rounded-md"></div><div><label class="text-sm font-medium">Time</label><div class="flex items-center mt-1"><input type="text" name="hour" placeholder="H" maxlength="2" class="w-12 p-2 border rounded-md text-center"><span class="font-bold mx-1">:</span><input type="text" name="minutes" placeholder="MM" maxlength="2" class="w-16 p-2 border rounded-md text-center"><select name="ampm" class="ml-2 p-2 border rounded-md bg-white"><option>AM</option><option>PM</option></select></div></div><div><label class="text-sm font-medium">Band Name</label><input type="text" name="name" class="w-full mt-1 p-2 border rounded-md" required></div><div class="lg:col-span-3"><label class="text-sm font-medium">Address</label><input type="text" name="address" class="w-full mt-1 p-2 border rounded-md"></div><div class="lg:col-span-3"><label class="text-sm font-medium">Google Maps Link</label><input type="url" name="googleMapsLink" class="w-full mt-1 p-2 border rounded-md"></div><div><label class="text-sm font-medium">Latitude</label><input type="text" name="latitude" placeholder="e.g., 40.7128" class="w-full mt-1 p-2 border rounded-md"></div><div><label class="text-sm font-medium">Longitude</label><input type="text" name="longitude" placeholder="e.g., -74.0060" class="w-full mt-1 p-2 border rounded-md"></div><div><label class="text-sm font-medium">Band Website</label><input type="url" name="band_website" class="w-full mt-1 p-2 border rounded-md"></div><div><label class="text-sm font-medium">Band Email</label><input type="email" name="band_email" class="w-full mt-1 p-2 border rounded-md"></div><div><label class="text-sm font-medium">Venue Name</label><input type="text" name="venue_name" class="w-full mt-1 p-2 border rounded-md"></div><div><label class="text-sm font-medium">Venue Website</label><input type="url" name="venue_website" class="w-full mt-1 p-2 border rounded-md"></div><div><label class="text-sm font-medium">Venue Phone</label><input type="tel" name="venue_phone_number" class="w-full mt-1 p-2 border rounded-md"></div><div><label class="text-sm font-medium">Venue Email</label><input type="email" name="venue_email" class="w-full mt-1 p-2 border rounded-md"></div></div><div class="mt-6 flex justify-end gap-4"><button type="button" class="modal-cancel-btn px-4 py-2 bg-slate-200 rounded-md">Cancel</button><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md">Add Gig</button></div></form></div></div>

<div id="add-venue-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-start justify-center p-4 hidden overflow-y-auto"><div class="w-full max-w-xl bg-white rounded-xl shadow-2xl m-4"><div class="p-6 border-b flex justify-between items-center"><h2 class="text-2xl font-bold text-slate-800">Add New Venue</h2><button class="modal-close-btn text-slate-400 hover:text-slate-600 text-2xl">&times;</button></div><form id="add-venue-form" class="p-6"><div class="space-y-4"><div><label class="text-sm font-medium">Venue Name</label><input type="text" name="venueName" placeholder="The Rock House" class="w-full mt-1 p-2 border rounded-md" required></div><div><label class="text-sm font-medium">Venue Address</label><input type="text" name="venueAddress" placeholder="123 Music Lane" class="w-full mt-1 p-2 border rounded-md"></div><div><label class="text-sm font-medium">Venue Website</label><input type="url" name="venueWebsite" placeholder="https://therockhouse.com" class="w-full mt-1 p-2 border rounded-md"></div><div><label class="text-sm font-medium">Venue Phone Number</label><input type="tel" name="venuePhoneNumber" placeholder="(555) 123-4567" class="w-full mt-1 p-2 border rounded-md"></div><div><label class="text-sm font-medium">Latitude</label><input type="text" name="latitude" placeholder="e.g., 40.9565" class="w-full mt-1 p-2 border rounded-md"></div><div><label class="text-sm font-medium">Longitude</label><input type="text" name="longitude" placeholder="e.g., -72.2451" class="w-full mt-1 p-2 border rounded-md"></div></div><div class="mt-6 flex justify-end gap-4"><button type="button" class="modal-cancel-btn px-4 py-2 bg-slate-200 rounded-md">Cancel</button><button type="submit" class="px-4 py-2 bg-teal-600 text-white rounded-md">Add Venue</button></div></form></div></div>
<div id="edit-venue-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-start justify-center p-4 hidden overflow-y-auto"><div class="w-full max-w-xl bg-white rounded-xl shadow-2xl m-4"><div class="p-6 border-b flex justify-between items-center"><h2 class="text-2xl font-bold text-slate-800">Edit Venue</h2><button class="modal-close-btn text-slate-400 hover:text-slate-600 text-2xl">&times;</button></div><form id="edit-venue-form" class="p-6"><input type="hidden" name="rowId"><div class="space-y-4"><div><label class="text-sm font-medium">Venue Name</label><input type="text" name="venueName" class="w-full mt-1 p-2 border rounded-md" required></div><div><label class="text-sm font-medium">Venue Address</label><input type="text" name="venueAddress" class="w-full mt-1 p-2 border rounded-md"></div><div><label class="text-sm font-medium">Venue Website</label><input type="url" name="venueWebsite" class="w-full mt-1 p-2 border rounded-md"></div><div><label class="text-sm font-medium">Venue Phone Number</label><input type="tel" name="venuePhoneNumber" class="w-full mt-1 p-2 border rounded-md"></div><div><label class="text-sm font-medium">Latitude</label><input type="text" name="latitude" placeholder="e.g., 40.9565" class="w-full mt-1 p-2 border rounded-md"></div><div><label class="text-sm font-medium">Longitude</label><input type="text" name="longitude" placeholder="e.g., -72.2451" class="w-full mt-1 p-2 border rounded-md"></div></div><div class="mt-6 flex justify-end gap-4"><button type="button" class="modal-cancel-btn px-4 py-2 bg-slate-200 rounded-md">Cancel</button><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md">Save Changes</button></div></form></div></div>

<div id="add-gallery-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-start justify-center p-4 hidden overflow-y-auto"><div class="w-full max-w-xl bg-white rounded-xl shadow-2xl m-4"><div class="p-6 border-b flex justify-between items-center"><h2 class="text-2xl font-bold text-slate-800">Add to Gallery</h2><button class="modal-close-btn text-slate-400 hover:text-slate-600 text-2xl">&times;</button></div><form id="add-gallery-form" class="p-6"><div class="space-y-4"><div><label class="text-sm font-medium">Image URL</label><input type="url" name="imageUrl" placeholder="https://example.com/image.jpg" class="w-full mt-1 p-2 border rounded-md" required></div><div><label class="text-sm font-medium">Text</label><textarea name="text" rows="3" placeholder="Enter descriptive text..." class="w-full mt-1 p-2 border rounded-md"></textarea></div><div><label class="text-sm font-medium">Band Website (Optional)</label><input type="url" name="website" placeholder="https://exampleband.com" class="w-full mt-1 p-2 border rounded-md"></div></div><div class="mt-4 border p-4 rounded-lg bg-slate-50"><h4 class="text-sm font-bold mb-2 text-slate-600">Preview</h4><div id="add-preview-container" class="text-center"><img id="add-preview-img" src="https://via.placeholder.com/400x200.png?text=Image+Preview" class="max-w-xs h-auto rounded-md mx-auto mb-2 bg-slate-200 object-cover" onerror="this.onerror=null; this.src='https://via.placeholder.com/400x200.png?text=Invalid+URL';"><p id="add-preview-text" class="text-slate-700 italic">Your text will appear here.</p></div></div><div class="mt-6 flex justify-end gap-4"><button type="button" class="modal-cancel-btn px-4 py-2 bg-slate-200 rounded-md">Cancel</button><button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-md">Add to Gallery</button></div></form></div></div>
<div id="edit-gallery-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-start justify-center p-4 hidden overflow-y-auto"><div class="w-full max-w-xl bg-white rounded-xl shadow-2xl m-4"><div class="p-6 border-b flex justify-between items-center"><h2 class="text-2xl font-bold text-slate-800">Edit Gallery Item</h2><button class="modal-close-btn text-slate-400 hover:text-slate-600 text-2xl">&times;</button></div><form id="edit-gallery-form" class="p-6"><input type="hidden" name="rowId"><div class="space-y-4"><div><label class="text-sm font-medium">Image URL</label><input type="url" name="imageUrl" class="w-full mt-1 p-2 border rounded-md" required></div><div><label class="text-sm font-medium">Text</label><textarea name="text" rows="3" class="w-full mt-1 p-2 border rounded-md"></textarea></div><div><label class="text-sm font-medium">Band Website (Optional)</label><input type="url" name="website" class="w-full mt-1 p-2 border rounded-md"></div></div><div class="mt-4 border p-4 rounded-lg bg-slate-50"><h4 class="text-sm font-bold mb-2 text-slate-600">Preview</h4><div id="edit-preview-container" class="text-center"><img id="edit-preview-img" src="https://via.placeholder.com/400x200.png?text=Image+Preview" class="max-w-xs h-auto rounded-md mx-auto mb-2 bg-slate-200 object-cover" onerror="this.onerror=null; this.src='https://via.placeholder.com/400x200.png?text=Invalid+URL';"><p id="edit-preview-text" class="text-slate-700 italic"></p></div></div><div class="mt-6 flex justify-end gap-4"><button type="button" class="modal-cancel-btn px-4 py-2 bg-slate-200 rounded-md">Cancel</button><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md">Save Changes</button></div></form></div></div>

<div id="confirm-modal-container" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[60] flex items-center justify-center p-4 hidden"><div class="confirm-modal"><h3 id="confirm-title" class="text-lg font-bold text-slate-800">Are you sure?</h3><p id="confirm-message" class="text-slate-600 mt-2 mb-6">This action cannot be undone.</p><div class="flex justify-center gap-4"><button id="confirm-cancel-btn" class="px-6 py-2 bg-slate-200 text-slate-800 rounded-md font-semibold">Cancel</button><button id="confirm-ok-btn" class="px-6 py-2 bg-red-600 text-white rounded-md font-semibold">Delete</button></div></div></div>
<div id="customAlert-container"></div>
<div id="loadingOverlay" style="display: none;"><i class="fas fa-spinner fa-spin fa-3x text-indigo-600"></i></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- URLs and State Variables ---
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyNt-oD_o9Vz0Uf9O-d16QMgb0HYsO_Gssy_GPu270oT9DIbzetPdrW72BhlrPgR29eBA/exec";
    
    const REVIEWS_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRaeCIG4k0nRJAk-IQJRWr9OzkaKEVEWon5mdULnGEPhhW1AHzVo4oXB6eEuGvRRVSglpWg4em18Ri0/pub?gid=1554482653&single=true&output=csv"; 
    const GIG_LIST_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRaeCIG4k0nRJAk-IQJRWr9OzkaKEVEWon5mdULnGEPhhW1AHzVo4oXB6eEuGvRRVSglpWg4em18Ri0/pub?gid=1813652457&single=true&output=csv";
    const GALLERY_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRaeCIG4k0nRJAk-IQJRWr9OzkaKEVEWon5mdULnGEPhhW1AHzVo4oXB6eEuGvRRVSglpWg4em18Ri0/pub?gid=1107946029&single=true&output=csv";
    const VENUES_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRaeCIG4k0nRJAk-IQJRWr9OzkaKEVEWon5mdULnGEPhhW1AHzVo4oXB6eEuGvRRVSglpWg4em18Ri0/pub?gid=1904894569&single=true&output=csv";

    let allReviews = [], allGigs = [], allGalleryItems = [], allVenues = [];

    // --- Element Selectors ---
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebar-overlay');
    const burgerBtn = document.getElementById('burger-btn');
    const passwordOverlay=document.getElementById("password-overlay"),passwordForm=document.getElementById("password-form"),passwordInput=document.getElementById("password-input"),passwordError=document.getElementById("password-error"),loginButton=document.getElementById("login-button");
    const loadingOverlay=document.getElementById("loadingOverlay"),customAlertContainer=document.getElementById("customAlert-container");
    const confirmModalContainer=document.getElementById('confirm-modal-container'),confirmTitle=document.getElementById('confirm-title'),confirmMessage=document.getElementById('confirm-message'),confirmOkBtn=document.getElementById('confirm-ok-btn'),confirmCancelBtn=document.getElementById('confirm-cancel-btn');

    const reviewsTableBody=document.getElementById("reviews-table-body"),noReviewsMessage=document.getElementById("no-reviews-message");
    const gigsTableBody=document.getElementById("gigs-table-body"),noGigsMessage=document.getElementById("no-gigs-message");
    const galleryTableBody = document.getElementById('gallery-table-body'), noGalleryMessage = document.getElementById('no-gallery-message');
    const venuesTableBody = document.getElementById('venues-table-body'), noVenuesMessage = document.getElementById('no-venues-message');
    
    const editGigModal=document.getElementById("edit-gig-modal"),editGigForm=document.getElementById("edit-gig-form");
    const addGigModal=document.getElementById("add-gig-modal"),addGigBtn=document.getElementById("add-gig-btn"),addGigForm=document.getElementById("add-gig-form");
    const addGalleryModal = document.getElementById('add-gallery-modal'), addGalleryBtn = document.getElementById('add-gallery-btn'), addGalleryForm = document.getElementById('add-gallery-form');
    const editGalleryModal = document.getElementById('edit-gallery-modal'), editGalleryForm = document.getElementById('edit-gallery-form');
    const addVenueModal = document.getElementById('add-venue-modal'), addVenueBtn = document.getElementById('add-venue-btn'), addVenueForm = document.getElementById('add-venue-form');
    const editVenueModal = document.getElementById('edit-venue-modal'), editVenueForm = document.getElementById('edit-venue-form');

    const navLinks={dashboard:document.getElementById("nav-dashboard"),reviews:document.getElementById("nav-reviews"),gigs:document.getElementById("nav-gigs"),venues:document.getElementById("nav-venues"),gallery:document.getElementById("nav-gallery")};
    const contentAreas={dashboard:document.getElementById("dashboard-content"),reviews:document.getElementById("reviews-content"),gigs:document.getElementById("gigs-content"),venues:document.getElementById('venues-content'),gallery:document.getElementById('gallery-content')};

    // --- Helper Functions ---
    const showLoading=s=>{loadingOverlay.style.display=s?"flex":"none"};
    const showCustomAlert=(m,type='info')=>{const t=document.createElement("div");t.className=`custom-alert-box alert-${type}`,t.textContent=m,customAlertContainer.innerHTML="",customAlertContainer.appendChild(t),setTimeout(()=>{t.classList.add("fade-out"),t.addEventListener("animationend",()=>t.remove())},3e3)};
    const showTab=t=>{Object.values(contentAreas).forEach(a=>a&&a.classList.add("hidden")),Object.values(navLinks).forEach(l=>l.classList.remove("active")),contentAreas[t]&&navLinks[t]?(contentAreas[t].classList.remove("hidden"),navLinks[t].classList.add("active")):(contentAreas.dashboard.classList.remove("hidden"),navLinks.dashboard.classList.add("active"))};
    const normalizeDate=e=>{if(!e)return"";const t=new Date(e);return isNaN(t.getTime())?"":`${t.getUTCFullYear()}-${String(t.getUTCMonth()+1).padStart(2,"0")}-${String(t.getUTCDate()).padStart(2,"0")}`};
    const formatTimeDisplay = timeStr => timeStr ? timeStr.replace(/:\d{2}\s/, ' ') : "";
    const parseTime = e => { if (!e) return { hour: "", minutes: "", ampm: "AM" }; const t = e.match(/(\d{1,2}):(\d{2})(:\d{2})?\s*(AM|PM)/i); return t ? { hour: t[1], minutes: t[2], ampm: t[4].toUpperCase() } : { hour: "", minutes: "", ampm: "AM" }; };
    const showConfirm=(t,m)=>{confirmTitle.textContent=t;confirmMessage.textContent=m;confirmModalContainer.classList.remove('hidden');return new Promise((resolve,reject)=>{confirmOkBtn.onclick=()=>{confirmModalContainer.classList.add('hidden');resolve();};confirmCancelBtn.onclick=()=>{confirmModalContainer.classList.add('hidden');reject();};})};
    
    // --- Data Population & Display ---
    const updateDashboard = () => {
        const pendingReviewsCount = allReviews.filter(r => !r.isApproved).length;
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const upcomingGigsCount = allGigs.filter(g => new Date(normalizeDate(g.date)) >= today).length;

        document.getElementById('dashboard-stat-upcoming').textContent = upcomingGigsCount;
        document.getElementById('dashboard-stat-pending').textContent = pendingReviewsCount;
        document.getElementById('dashboard-stat-total-gigs').textContent = allGigs.length;
        document.getElementById('dashboard-stat-total-reviews').textContent = allReviews.length;

        const upcomingGigsContainer = document.getElementById('dashboard-upcoming-gigs');
        upcomingGigsContainer.innerHTML = '';
        const upcomingGigs = allGigs.filter(g => new Date(normalizeDate(g.date)) >= today).sort((a, b) => new Date(normalizeDate(a.date)) - new Date(normalizeDate(b.date))).slice(0, 5);

        if (upcomingGigs.length > 0) {
            upcomingGigs.forEach(gig => {
                const gigEl = document.createElement('div');
                gigEl.className = 'flex items-center justify-between p-3 rounded-lg hover:bg-slate-50';
                gigEl.innerHTML = `<div><p class="font-semibold text-slate-800">${gig.name}</p><p class="text-sm text-slate-500">${gig.venueName||'N/A'}</p></div><div class="text-right"><p class="font-medium text-slate-700">${gig.date}</p><p class="text-sm text-slate-500">${formatTimeDisplay(gig.time)}</p></div>`;
                upcomingGigsContainer.appendChild(gigEl);
            });
        } else {
            upcomingGigsContainer.innerHTML = '<p class="text-slate-500 text-center py-8">No upcoming gigs found.</p>';
        }

        const pendingReviewsContainer = document.getElementById('dashboard-pending-reviews');
        pendingReviewsContainer.innerHTML = '';
        const pendingReviews = allReviews.filter(r => !r.isApproved).slice(0, 5);

        if (pendingReviews.length > 0) {
            pendingReviews.forEach(review => {
                const reviewEl = document.createElement('div');
                reviewEl.className = 'p-3 rounded-lg hover:bg-slate-50';
                reviewEl.innerHTML = `<div class="flex items-center justify-between"><div><p class="font-semibold text-slate-800">${review.name}</p><p class="text-sm text-slate-500">${review.gigName}</p></div><div class="flex">${Array.from({ length: 5 }, (v, i) => `<i class="fa-solid fa-star ${i < review.rating ? 'text-amber-400' : 'text-slate-300'}"></i>`).join('')}</div></div>`;
                pendingReviewsContainer.appendChild(reviewEl);
            });
        } else {
            pendingReviewsContainer.innerHTML = '<p class="text-slate-500 text-center py-8">No pending reviews.</p>';
        }
    };

    const populateReviewsStats=()=>{const e=allReviews.filter(e=>e.isApproved).length;document.getElementById("stat-total-reviews").textContent=allReviews.length,document.getElementById("stat-approved-reviews").textContent=e,document.getElementById("stat-pending-reviews").textContent=allReviews.length-e};
    const populateGigsStats=()=>{const e=new Date;e.setHours(0,0,0,0);let t=0,o=0;allGigs.forEach(s=>{const n=new Date(normalizeDate(s.date));n>=e?t++:o++}),document.getElementById("stat-total-gigs").textContent=allGigs.length,document.getElementById("stat-upcoming-gigs").textContent=t,document.getElementById("stat-past-gigs").textContent=o};
    const populateGalleryStats = () => { document.getElementById("stat-total-gallery-items").textContent = allGalleryItems.length; };
    const populateVenuesStats = () => { document.getElementById("stat-total-venues").textContent = allVenues.length; };
    const populateReviewsTable=()=>{reviewsTableBody.innerHTML="",allReviews.length?(noReviewsMessage.style.display="none",allReviews.sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt)).forEach((e,t)=>{const o=document.createElement("tr");o.className="border-b",o.dataset.id=e.row;const s=e.isApproved?"bg-green-100 text-green-800":"bg-yellow-100 text-yellow-800",n=e.isApproved?"Approved":"Pending",a=e.isApproved?`<button class="unapprove-btn text-white bg-slate-500 hover:bg-slate-600 text-xs px-3 py-1.5 rounded-lg" title="Un-approve"><i class="fas fa-times"></i></button>`:`<button class="approve-btn text-white bg-green-500 hover:bg-green-600 text-xs px-3 py-1.5 rounded-lg" title="Approve"><i class="fas fa-check"></i></button>`;o.innerHTML=`<td class="px-2 md:px-6 py-4 font-medium text-slate-500">${t+1}</td><td class="px-2 md:px-6 py-4"><div class="font-medium">${e.name}</div><div class="text-slate-500">${e.hometown||"N/A"}</div></td><td class="px-2 md:px-6 py-4"><div class="font-medium">${e.gigName}</div><div class="text-slate-500">${e.gigVenue}</div></td><td class="px-2 md:px-6 py-4"><div class="flex">${Array.from({length:5},(t,o)=>`<i class="fa-solid fa-star ${o<e.rating?"text-amber-400":"text-slate-300"}"></i>`).join("")}</div></td><td class="px-2 md:px-6 py-4 max-w-xs truncate" title="${e.reviewText}">${e.reviewText}</td><td class="px-2 md:px-6 py-4 text-center"><span class="status-badge text-xs px-2.5 py-0.5 rounded-full ${s}">${n}</span></td><td class="px-2 md:px-6 py-4 text-center"><div class="flex items-center justify-center gap-2">${a}<button class="delete-btn text-white bg-red-500 hover:bg-red-600 text-xs px-3 py-1.5 rounded-lg" title="Delete"><i class="fas fa-trash"></i></button></div></td>`,reviewsTableBody.appendChild(o)})):(noReviewsMessage.style.display="block",noReviewsMessage.querySelector("p").textContent="No reviews found.")};
    const populateGigsTable=()=>{gigsTableBody.innerHTML="",allGigs.length?(noGigsMessage.style.display="none",allGigs.forEach((e,t)=>{const o=document.createElement("tr");o.className="border-b",o.dataset.rowId=e.row,o.innerHTML=`<td class="px-2 md:px-6 py-4 font-medium text-slate-500">${t+1}</td><td class="px-2 md:px-6 py-4"><div>${e.date||""}</div><div class="text-sm text-slate-500">${formatTimeDisplay(e.time)}</div></td><td class="px-2 md:px-6 py-4 font-medium">${e.name||""}</td><td class="px-2 md:px-6 py-4">${e.venueName||""}</td><td class="px-2 md:px-6 py-4">${e.address||""}</td><td class="px-2 md:px-6 py-4 text-center"><div class="flex items-center justify-center gap-2"><button class="edit-gig-btn text-white bg-blue-500 hover:bg-blue-600 text-xs px-3 py-1.5 rounded-lg" title="Edit"><i class="fas fa-pencil-alt"></i></button><button class="delete-gig-btn text-white bg-red-500 hover:bg-red-600 text-xs px-3 py-1.5 rounded-lg" title="Delete"><i class="fas fa-trash"></i></button></div></td>`,gigsTableBody.appendChild(o)})):(noGigsMessage.style.display="block",noGigsMessage.querySelector("p").textContent="No gigs found.")};
    const populateGalleryTable = () => {galleryTableBody.innerHTML = ""; if (allGalleryItems.length) { noGalleryMessage.style.display = "none"; allGalleryItems.forEach((item, index) => { const row = document.createElement("tr"); row.className = "border-b"; row.dataset.rowId = item.row; const websiteCell = item.website ? `<a href="${item.website}" target="_blank" rel="noopener noreferrer" class="text-indigo-600 hover:text-indigo-800 hover:underline break-all">${item.website}</a>` : `<span class="text-slate-400">N/A</span>`; row.innerHTML = `<td class="px-2 md:px-6 py-4 font-medium text-slate-500">${index + 1}</td><td class="px-2 md:px-6 py-4"><img src="${item.imageUrl}" class="w-32 h-20 object-cover rounded-md bg-slate-200" onerror="this.onerror=null; this.src='https://via.placeholder.com/128x80.png?text=Error';"></td><td class="px-2 md:px-6 py-4 max-w-xs"><p class="whitespace-pre-wrap">${item.text || ''}</p></td><td class="px-2 md:px-6 py-4 max-w-xs">${websiteCell}</td><td class="px-2 md:px-6 py-4 text-center"><div class="flex items-center justify-center gap-2"><button class="edit-gallery-btn text-white bg-blue-500 hover:bg-blue-600 text-xs px-3 py-1.5 rounded-lg" title="Edit"><i class="fas fa-pencil-alt"></i></button><button class="delete-gallery-btn text-white bg-red-500 hover:bg-red-600 text-xs px-3 py-1.5 rounded-lg" title="Delete"><i class="fas fa-trash"></i></button></div></td>`; galleryTableBody.appendChild(row); }); } else { noGalleryMessage.style.display = "block"; noGalleryMessage.querySelector("p").textContent = "No gallery items found."; }};
    const populateVenuesTable = () => {venuesTableBody.innerHTML = ""; if (allVenues.length) { noVenuesMessage.style.display = "none"; allVenues.forEach((venue, index) => { const row = document.createElement("tr"); row.className = "border-b"; row.dataset.rowId = venue.row; const websiteCell = venue.website ? `<a href="${venue.website}" target="_blank" rel="noopener noreferrer" class="text-indigo-600 hover:text-indigo-800 hover:underline break-all">${venue.website}</a>` : `<span class="text-slate-400">N/A</span>`; row.innerHTML = `<td class="px-2 md:px-6 py-4 font-medium text-slate-500">${index + 1}</td><td class="px-2 md:px-6 py-4 font-medium">${venue.name || ''}</td><td class="px-2 md:px-6 py-4">${venue.address || ''}</td><td class="px-2 md:px-6 py-4 max-w-xs">${websiteCell}</td><td class="px-2 md:px-6 py-4">${venue.phone || ''}</td><td class="px-2 md:px-6 py-4 text-center"><div class="flex items-center justify-center gap-2"><button class="edit-venue-btn text-white bg-blue-500 hover:bg-blue-600 text-xs px-3 py-1.5 rounded-lg" title="Edit"><i class="fas fa-pencil-alt"></i></button><button class="delete-venue-btn text-white bg-red-500 hover:bg-red-600 text-xs px-3 py-1.5 rounded-lg" title="Delete"><i class="fas fa-trash"></i></button></div></td>`; venuesTableBody.appendChild(row); }); } else { noVenuesMessage.style.display = "block"; noVenuesMessage.querySelector("p").textContent = "No venues found."; }};

    // --- Data Loading ---
    const loadAppData = async () => {
        showLoading(true);
        try {
            const fetchPromises = [];
            
            fetchPromises.push(new Promise((resolve, reject) => {
                if (!REVIEWS_CSV_URL || REVIEWS_CSV_URL === "PASTE_YOUR_REVIEW_DATABASE_CSV_URL_HERE") {
                    showCustomAlert("Review CSV URL is missing.", "error");
                    return reject("Review CSV URL is missing.");
                }
                Papa.parse(REVIEWS_CSV_URL, {
                    download: true, header: true, skipEmptyLines: true,
                    transformHeader: h => (h.trim().charAt(0).toLowerCase() + h.slice(1)).replace(/\s+/g, ''),
                    complete: result => {
                        allReviews = result.data.map((r, i) => ({
                            ...r,
                            row: i + 2,
                            isApproved: String(r.approval || 'false').trim().toLowerCase() === 'true'
                        }));
                        populateReviewsTable();
                        populateReviewsStats();
                        resolve();
                    },
                    error: err => {
                        console.error("PapaParse Reviews Error:", err);
                        showCustomAlert("Failed to load Reviews CSV.", "error");
                        reject(err);
                    }
                });
            }));

            fetchPromises.push(new Promise((resolve, reject) => {
                Papa.parse(GIG_LIST_CSV_URL, {
                    download: true, header: true, skipEmptyLines: true,
                    transformHeader: h => h.trim().toLowerCase(),
                    complete: result => {
                        allGigs = result.data.map((g, i) => ({
                            name: g.name || "",
                            bandWebsite: g["band website"] || "",
                            bandEmail: g["band email"] || "",
                            venueName: g["venue name"] || "",
                            address: g.address || "",
                            venueWebsite: g["venue website"] || "",
                            venuePhone: g["venue phone number"] || "",
                            venueEmail: g["venue email"] || "",
                            date: g.date || "",
                            time: g.time || "",
                            googleMapsLink: g["google maps link"] || "",
                            latitude: g.latitude || "",
                            longitude: g.longitude || "",
                            row: i + 2
                        }));
                        populateGigsTable();
                        populateGigsStats();
                        resolve();
                    },
                    error: err => {
                        console.error("PapaParse Gigs Error:", err);
                        showCustomAlert("Failed to load Gigs CSV.", "error");
                        reject(err);
                    }
                });
            }));

            fetchPromises.push(new Promise((resolve, reject) => {
                Papa.parse(GALLERY_CSV_URL, {
                    download: true, header: true, skipEmptyLines: true,
                    transformHeader: h => h.trim().toLowerCase().replace(/\s+/g, ''),
                    complete: result => {
                        allGalleryItems = result.data.map((item, index) => ({
                            imageUrl: item.imageurl || "",
                            text: item.text || "",
                            website: item.website || "",
                            row: index + 2
                        }));
                        populateGalleryTable();
                        populateGalleryStats();
                        resolve();
                    },
                    error: err => {
                        console.error("PapaParse Gallery Error:", err);
                        showCustomAlert("Failed to load Gallery CSV.", "error");
                        reject(err);
                    }
                });
            }));
            
            fetchPromises.push(new Promise((resolve, reject) => {
                Papa.parse(VENUES_CSV_URL, {
                    download: true, header: true, skipEmptyLines: true,
                    transformHeader: h => h.trim().toLowerCase().replace(/\s+/g, ''),
                    complete: result => {
                        allVenues = result.data.map((v, i) => ({
                            name: v.name || v.venuename || "",
                            address: v.address || v.venueaddress || "",
                            website: v.website || v.venuewebsite || "",
                            phone: v.phone || v.venuephonenumber || "",
                            latitude: v.latitude || "",
                            longitude: v.longitude || "",
                            row: i + 2
                        }));
                        populateVenuesTable();
                        populateVenuesStats();
                        resolve();
                    },
                    error: err => {
                        console.error("PapaParse Venues Error:", err);
                        showCustomAlert("Failed to load Venues CSV.", "error");
                        reject(err);
                    }
                });
            }));
            
            await Promise.all(fetchPromises);
            updateDashboard();
        } catch (e) {
            console.error("Error loading data:", e);
            showCustomAlert(`Error: ${e.message}`, "error");
        } finally {
            showLoading(false);
        }
    };
    
    // --- Action Handling & Form Submission ---
    const handleAction = async (action, rowId, button, type) => {
        const icon = button.querySelector("i"), originalIconClass = icon.className;
        icon.className = "fas fa-spinner btn-spinner", button.disabled = true;
        try {
            const formData = new FormData;
            formData.append("action", action), formData.append("rowId", rowId);
            const response = await fetch(APPS_SCRIPT_URL, { method: "POST", body: formData });
            if (!response.ok) throw new Error("Server error");
            const result = await response.json();
            if ("success" !== result.status) throw new Error(result.message);
            
            if (action.startsWith('delete')) {
                showCustomAlert(`${type} permanently deleted!`, "success");
                if (type === "Review") { allReviews = allReviews.filter(review => review.row != rowId); populateReviewsTable(); populateReviewsStats(); } 
                else if (type === "Gig") { allGigs = allGigs.filter(gig => gig.row != rowId); populateGigsTable(); populateGigsStats(); } 
                else if (type === "Gallery Item") { allGalleryItems = allGalleryItems.filter(item => item.row != rowId); populateGalleryTable(); populateGalleryStats(); }
                else if (type === "Venue") { allVenues = allVenues.filter(venue => venue.row != rowId); populateVenuesTable(); populateVenuesStats(); }
            } else { // Handle approve/unapprove for reviews
                const reviewToUpdate = allReviews.find(review => review.row == rowId);
                if (reviewToUpdate) {
                    reviewToUpdate.isApproved = action === "approveReview";
                    showCustomAlert(reviewToUpdate.isApproved ? "Review approved!" : "Review un-approved.", "success");
                    populateReviewsTable();
                    populateReviewsStats();
                } else { throw new Error("Review not found for update."); }
            }
        } catch (e) { showCustomAlert(`Error: ${e.message}`, "error"); } finally { icon.className = originalIconClass; button.disabled = false; updateDashboard(); }
    };
    const submitGigForm = async e => {
        e.preventDefault();
        const form = e.target, isAddMode = form.id === 'add-gig-form', submitBtn = form.querySelector('button[type="submit"]');
        submitBtn.disabled = true, submitBtn.textContent = isAddMode ? "Adding..." : "Saving...";
        const formData = new FormData(form);
        formData.append("action", isAddMode ? "addGig" : "updateGig");
        const hour = form.elements.hour.value || '12'; const minutes = String(form.elements.minutes.value || '00').padStart(2, '0'); const ampm = form.elements.ampm.value; const time = `${hour}:${minutes} ${ampm}`;
        formData.append("time", time); formData.delete('hour'); formData.delete('minutes'); formData.delete('ampm');
        try {
            const response = await fetch(APPS_SCRIPT_URL, { method: "POST", body: formData });
            if (!response.ok) throw new Error("Server communication error.");
            const result = await response.json();
            if (result.status !== 'success') throw new Error(result.message);
            showCustomAlert(isAddMode ? "Gig added successfully!" : "Gig updated successfully!", "success");
            (isAddMode ? addGigModal : editGigModal).classList.add('hidden');
            
            if (isAddMode) {
                allGigs.push(result.newGig);
            } else {
                const updatedRowId = form.elements.rowId.value;
                const gigToUpdate = allGigs.find(gig => gig.row == updatedRowId);
                if (gigToUpdate) {
                    Object.assign(gigToUpdate, {
                        date: form.elements.date.value.replace(/-/g, '/'),
                        time: time,
                        name: form.elements.name.value,
                        address: form.elements.address.value,
                        googleMapsLink: form.elements.googleMapsLink.value,
                        latitude: form.elements.latitude.value,
                        longitude: form.elements.longitude.value,
                        bandWebsite: form.elements.band_website.value,
                        bandEmail: form.elements.band_email.value,
                        venueName: form.elements.venue_name.value,
                        venueWebsite: form.elements.venue_website.value,
                        venuePhone: form.elements.venue_phone_number.value,
                        venueEmail: form.elements.venue_email.value
                    });
                }
            }
            populateGigsTable();
            populateGigsStats();
            updateDashboard();

        } catch (error) { 
            showCustomAlert(`Error: ${error.message}`, "error"); 
        } finally { 
            submitBtn.disabled = false; 
            submitBtn.textContent = isAddMode ? "Add Gig" : "Save Changes"; 
            if (isAddMode) form.reset(); 
        }
    };
    const submitGalleryForm = async e => {
        e.preventDefault();
        const form = e.target, isAddMode = form.id === 'add-gallery-form', modal = isAddMode ? addGalleryModal : editGalleryModal, submitBtn = form.querySelector('button[type="submit"]');
        submitBtn.disabled = true, submitBtn.textContent = isAddMode ? "Adding..." : "Saving...";
        const formData = new FormData(form); formData.append("action", isAddMode ? "addGalleryItem" : "updateGalleryItem");
        try {
            const response = await fetch(APPS_SCRIPT_URL, { method: "POST", body: formData });
            if (!response.ok) throw new Error("Server communication error.");
            const result = await response.json();
            if (result.status !== 'success') throw new Error(result.message);
            showCustomAlert(isAddMode ? "Image added successfully!" : "Image updated successfully!", "success");
            modal.classList.add('hidden');
            
            if (isAddMode) {
                allGalleryItems.push(result.newGalleryItem);
            } else {
                const updatedRowId = form.elements.rowId.value;
                const itemToUpdate = allGalleryItems.find(item => item.row == updatedRowId);
                if (itemToUpdate) {
                    Object.assign(itemToUpdate, {
                        imageUrl: form.elements.imageUrl.value,
                        text: form.elements.text.value,
                        website: form.elements.website.value
                    });
                }
            }
            populateGalleryTable();
            populateGalleryStats();
            updateDashboard();

        } catch (error) {
            showCustomAlert(`Error: ${error.message}`, "error");
        } finally {
            submitBtn.disabled = false, submitBtn.textContent = isAddMode ? "Add to Gallery" : "Save Changes";
            if (isAddMode) {
                form.reset();
                document.getElementById('add-preview-img').src = 'https://via.placeholder.com/400x200.png?text=Image+Preview';
                document.getElementById('add-preview-text').textContent = 'Your text will appear here.';
            }
        }
    };
    const submitVenueForm = async e => {
        e.preventDefault();
        const form = e.target, isAddMode = form.id === 'add-venue-form', modal = isAddMode ? addVenueModal : editVenueModal, submitBtn = form.querySelector('button[type="submit"]');
        submitBtn.disabled = true, submitBtn.textContent = isAddMode ? "Adding..." : "Saving...";
        const formData = new FormData(form); formData.append("action", isAddMode ? "addVenue" : "updateVenue");
        try {
            const response = await fetch(APPS_SCRIPT_URL, { method: "POST", body: formData });
            if (!response.ok) throw new Error("Server communication error."); 
            const result = await response.json(); 
            if (result.status !== 'success') throw new Error(result.message);
            showCustomAlert(isAddMode ? "Venue added successfully!" : "Venue updated successfully!", "success"); 
            modal.classList.add('hidden');
            
            if (isAddMode) {
                allVenues.push(result.newVenue);
            } else {
                const updatedRowId = form.elements.rowId.value;
                const venueToUpdate = allVenues.find(v => v.row == updatedRowId);
                if (venueToUpdate) {
                    Object.assign(venueToUpdate, {
                        name: form.elements.venueName.value,
                        address: form.elements.venueAddress.value,
                        website: form.elements.venueWebsite.value,
                        phone: form.elements.venuePhoneNumber.value,
                        latitude: form.elements.latitude.value,
                        longitude: form.elements.longitude.value
                    });
                }
            }
            populateVenuesTable();
            populateVenuesStats();
            updateDashboard();

        } catch (error) { 
            showCustomAlert(`Error: ${error.message}`, "error"); 
        } finally { 
            submitBtn.disabled = false, submitBtn.textContent = isAddMode ? "Add Venue" : "Save Changes"; 
            if (isAddMode) form.reset(); 
        }
    };

    // --- Event Listeners ---
    passwordForm.addEventListener("submit",async e=>{e.preventDefault(),passwordError.textContent="",loginButton.disabled=!0,loginButton.textContent="Verifying...";try{const t=new FormData;t.append("action","validatePassword"),t.append("password",passwordInput.value);const o=await fetch(APPS_SCRIPT_URL,{method:"POST",body:t});if(!o.ok)throw new Error("Network error");const s=await o.json();if("success"===s.status)passwordOverlay.style.transition="opacity 0.5s ease",passwordOverlay.style.opacity="0",setTimeout(()=>{passwordOverlay.style.display="none",loadAppData()},500);else throw new Error(s.message||"Incorrect password.")}catch(e){passwordError.textContent=e.message,loginButton.disabled=!1,loginButton.textContent="Login"}});
    reviewsTableBody.addEventListener("click",async e=>{const t=e.target.closest("button");if(!t)return;const o=t.closest("tr").dataset.id;if(t.classList.contains("approve-btn"))handleAction("approveReview",o,t,"Review");else if(t.classList.contains("unapprove-btn"))handleAction("unapproveReview",o,t,"Review");else if(t.classList.contains("delete-btn"))try{const e=allReviews.find(e=>e.row==o).name;await showConfirm("Delete Review?",`Are you sure you want to permanently delete the review by ${e}?`),handleAction("deleteReview",o,t,"Review")}catch(e){}});
    gigsTableBody.addEventListener("click", async event => {
        const button = event.target.closest("button"); if (!button) return;
        const rowId = button.closest("tr").dataset.rowId; const gigData = allGigs.find(g => g.row == rowId); if (!gigData) return;
        if (button.classList.contains("edit-gig-btn")) {
            const timeParts = parseTime(gigData.time);
            editGigForm.elements.rowId.value = gigData.row; editGigForm.elements.date.value = normalizeDate(gigData.date); editGigForm.elements.hour.value = timeParts.hour; editGigForm.elements.minutes.value = timeParts.minutes; editGigForm.elements.ampm.value = timeParts.ampm; editGigForm.elements.name.value = gigData.name; editGigForm.elements.address.value = gigData.address; editGigForm.elements.googleMapsLink.value = gigData.googleMapsLink; editGigForm.elements.band_website.value = gigData.bandWebsite; editGigForm.elements.band_email.value = gigData.bandEmail; editGigForm.elements.venue_name.value = gigData.venueName; editGigForm.elements.venue_website.value = gigData.venueWebsite; editGigForm.elements.venue_phone_number.value = gigData.venuePhone; editGigForm.elements.venue_email.value = gigData.venueEmail; editGigForm.elements.latitude.value = gigData.latitude; editGigForm.elements.longitude.value = gigData.longitude; editGigModal.classList.remove("hidden");
        } else if (button.classList.contains("delete-gig-btn")) { try { await showConfirm("Delete Gig?", `Are you sure you want to permanently delete the gig for ${gigData.name} on ${gigData.date}?`); handleAction("deleteGig", rowId, button, "Gig"); } catch (err) { /* User cancelled */ } }
    });
    galleryTableBody.addEventListener("click", async e => {const button = e.target.closest("button"); if (!button) return; const rowId = button.closest("tr").dataset.rowId; const item = allGalleryItems.find(i => i.row == rowId); if (button.classList.contains("edit-gallery-btn")) { editGalleryForm.elements.rowId.value = item.row; editGalleryForm.elements.imageUrl.value = item.imageUrl; editGalleryForm.elements.text.value = item.text; editGalleryForm.elements.website.value = item.website; document.getElementById('edit-preview-img').src = item.imageUrl || 'https://via.placeholder.com/400x200.png?text=Image+Preview'; document.getElementById('edit-preview-text').textContent = item.text || 'Your text will appear here.'; editGalleryModal.classList.remove("hidden"); } else if (button.classList.contains("delete-gallery-btn")) { try { await showConfirm("Delete Gallery Item?", `Are you sure you want to permanently delete this gallery item?`); handleAction("deleteGalleryItem", rowId, button, "Gallery Item"); } catch (err) { /* User cancelled */ } } });
    venuesTableBody.addEventListener("click", async e => { const button = e.target.closest("button"); if (!button) return; const rowId = button.closest("tr").dataset.rowId; const venue = allVenues.find(v => v.row == rowId); if (button.classList.contains("edit-venue-btn")) { editVenueForm.elements.rowId.value = venue.row; editVenueForm.elements.venueName.value = venue.name; editVenueForm.elements.venueAddress.value = venue.address; editVenueForm.elements.venueWebsite.value = venue.website; editVenueForm.elements.venuePhoneNumber.value = venue.phone; editVenueForm.elements.latitude.value = venue.latitude; editVenueForm.elements.longitude.value = venue.longitude; editVenueModal.classList.remove("hidden"); } else if (button.classList.contains("delete-venue-btn")) { try { await showConfirm("Delete Venue?", `Are you sure you want to permanently delete the venue "${venue.name}"?`); handleAction("deleteVenue", rowId, button, "Venue"); } catch (err) { /* User cancelled */ } } });
    addGigBtn.addEventListener('click', () => { addGigForm.reset(); addGigModal.classList.remove('hidden'); });
    addGalleryBtn.addEventListener('click', () => { addGalleryForm.reset(); addGalleryModal.classList.remove('hidden'); });
    addVenueBtn.addEventListener('click', () => { addVenueForm.reset(); addVenueModal.classList.remove('hidden'); });
    addGigForm.addEventListener("submit",submitGigForm);
    editGigForm.addEventListener("submit",submitGigForm);
    addGalleryForm.addEventListener("submit", submitGalleryForm);
    editGalleryForm.addEventListener("submit", submitGalleryForm);
    addVenueForm.addEventListener('submit', submitVenueForm);
    editVenueForm.addEventListener('submit', submitVenueForm);
    const setupPreview = (formId, imgId, textId, defaultText) => { const form = document.getElementById(formId), img = document.getElementById(imgId), text = document.getElementById(textId), urlInput = form.elements.imageUrl, textInput = form.elements.text; urlInput.addEventListener('input', () => { img.src = urlInput.value || 'https://via.placeholder.com/400x200.png?text=Image+Preview'; }); textInput.addEventListener('input', () => { text.textContent = textInput.value || defaultText; }); };
    setupPreview('add-gallery-form', 'add-preview-img', 'add-preview-text', 'Your text will appear here.');
    setupPreview('edit-gallery-form', 'edit-preview-img', 'edit-preview-text', '');

    // --- Mobile Sidebar Logic ---
    const toggleSidebar = () => {
        sidebar.classList.toggle('-translate-x-full');
        sidebarOverlay.classList.toggle('hidden');
    };
    burgerBtn.addEventListener('click', toggleSidebar);
    sidebarOverlay.addEventListener('click', toggleSidebar);
    document.querySelectorAll('.sidebar-link').forEach(link => {
        link.addEventListener('click', () => {
            if (window.innerWidth < 768) { // md breakpoint in tailwind
                toggleSidebar();
            }
        });
    });

    // --- General Setup ---
    document.querySelectorAll('.modal-close-btn, .modal-cancel-btn').forEach(b=>b.addEventListener('click',()=>b.closest('.fixed').classList.add('hidden')));
    Object.keys(navLinks).forEach(t=>{navLinks[t]&&navLinks[t].addEventListener("click",e=>{e.preventDefault(),showTab(t)})});
    document.getElementById('dashboard-view-gigs-btn').addEventListener('click', () => showTab('gigs'));
    document.getElementById('dashboard-view-reviews-btn').addEventListener('click', () => showTab('reviews'));
    showTab('dashboard');
});
</script>
</body>
</html>
